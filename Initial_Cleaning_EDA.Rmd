---
title: "Final Project R Notebook"
output: html_notebook
---

#Introduction to Data Set
For our final project, our group decided to tackle the Shelter Animal Outcomes Kaggle competition (found here: https://www.kaggle.com/c/shelter-animal-outcomes/data). This data comes from the Austin Animal Center from October 1st, 2013 to March, 2016. Fun fact is that one of our group members actually worked at this animal center back in Austin!

This dataset contains information about cats and dogs that were sheltered at the Austin Animal Center. It contains general info about the animals like: type of animal, breed, color, age on outcome, etc.; where the outcome of interest in this competition represent the status of animals as they leave the Animal Center. Some of the data columns required cleanup or transformation to be of more use to us (e.g. splitting the Sex column into the animals Sex as well as the status of their sexual organs - neutered/intact/etc.), while others were of no value when it comes to trying to apply our models. All animals receive a unique Animal ID during intake. 

Our goal is to predict the outcome of animals as they leave the animal center. The outcomes can be one of the following: Adoption, Died, Euthanasia, Return to owner, and Transfer. 

The train and test data were randomly split for us already.  

It is our belief that producing an accurate and detailed model to help predict outcomes for these shelter animals could help the Austin Animal Center and the animals themselves in a couple ways:
- Help the animal center better predict the outcome of a new animal that comes into the shelter. And depending on that predicted outcome, take proactive measures to steer "assist" the animal in receiving a better outcome based on what our model tells us makes for a pet that is more likely to be adopted.
- Help the animal center better predict allocation of resources based on what actions might need to be taken for each pet in order to maximize the number of positive outcomes for the shelter animals.

# #Helper Functions for Data Cleanup and EDA
```{r}
#Helper function to convert the values in the AgeuponOutcome column from time strings (e.g. 1 year, 2 months, etc.) into time in days
timeWarp <- function(age) {
  age_elements <- str_split_fixed(age,"\\s",2)
  norm_age = as.numeric(age_elements[1])
  norm_age
  time_unit = age_elements[2]
  #Based on unit of time, appropriately scale up age variable
  if (grepl(time_unit, "week") | grepl(time_unit, "weeks")) {
    norm_age = norm_age*7
  } else if (grepl(time_unit, "month") | grepl(time_unit, "months")) {
    norm_age = norm_age*30 
  } else if (grepl(time_unit, "year") | grepl(time_unit, "years")) {
    norm_age = norm_age * 365
  }
  return(norm_age)
}
```


## Exploratory Data Analysis of Data
```{r}
#Load Libraries I need
library(tidyverse)
library(ggplot2)
library(DataExplorer)
library(caret)
library(gridExtra)
library(reshape)
library(purrr)

#Load in data and start transforming it
animal_out <- read_csv(gzfile("data/train.csv.gz")) %>% 
               select(-DateTime) %>% 
               transform(SexuponOutcome = colsplit(SexuponOutcome, split = "\\s+", names = c('Sexual_Organ_Status', 'Sex')))

animal_in <- read_csv("data/Austin_Animal_Center_Intakes.csv")

animal_out$AgeuponOutcome <- vapply(animal_out$AgeuponOutcome, FUN = timeWarp, FUN.VALUE = double(1)) 

#Convert Name column into factor so we can see if the fact that the pet had a name documented affected it's outcome. 1=Had Name, 0=Name Unknown
animal_out$Sexual_Organ_Status <- animal_out$SexuponOutcome$Sexual_Organ_Status
animal_out$Sex <- animal_out$SexuponOutcome$Sex

animal_out$Name[!is.na(animal_out$Name)] <- 1
animal_out$Name[is.na(animal_out$Name)] <- 0
animal_out$Name <- as.factor(animal_out$Name)

animal_out$OutcomeSubtype[is.na(animal_out$OutcomeSubtype)] <- "None"

#Final steps of cleaning up my data
cad <- animal_out %>% 
       select(-SexuponOutcome) %>% 
       na.omit()
```

```{r Initial view of data}
View(cad)
introduce(cad)
```
There are 1380 unique breeds in the dataset. This is far too many
```{r}
length(unique(cad$Breed))
```
## Feature Engineering
First we need to clean the dataset to move "mix" into its own feature and keep only the first breed mentioned for the breed mixes
```{r Breed_Features}
cad <- cad %>%
  mutate(mix = ifelse(grepl("mix", Breed, ignore.case = T), 1, 0),
         breed_new = gsub(" Mix", "", Breed),
         breed_new = strsplit(x = breed_new, split = "/"),
         breed_new = map_chr(breed_new, function(x){unlist(x[1])}))
```

It does look like there are a number of popular breeds that take up more than 75% of the dataset: 
```{r}
cad %>%
  count(breed_new, sort = TRUE) %>%
  mutate(freq = round(100 * n / sum(n),2)) %>%
  head(16)
```
```{r}
count(cad, breed_new) %>%
    arrange(desc(n)) %>%
    filter(n > 222) -> common

cad <- cad %>%
  mutate(breed_new = replace(breed_new, !(breed_new %in% common$breed_new), "Uncommon"))
```
We've now grouped the 1365 sparse class breeds into one "Uncommon" group. 
```{r}
cad %>%
  count(breed_new, sort = TRUE) %>%
  mutate(freq = round(100 * n / sum(n),2)) 
```


