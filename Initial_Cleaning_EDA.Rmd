---
title: "Final Project R Notebook"
output: html_notebook
---

# #Helper Functions for Data Cleanup and EDA
```{r}
#Helper function to convert the values in the AgeuponOutcome column from time strings (e.g. 1 year, 2 months, etc.) into time in days
timeWarp <- function(age) {
  age_elements <- str_split_fixed(age,"\\s",2)
  norm_age = as.numeric(age_elements[1])
  norm_age
  time_unit = age_elements[2]
  if (grepl(time_unit, "week") | grepl(time_unit, "weeks")) {
    norm_age = norm_age*7
  } else if (grepl(time_unit, "month") | grepl(time_unit, "months")) {
    norm_age = norm_age*30 
  } else if (grepl(time_unit, "year") | grepl(time_unit, "years")) {
    norm_age = norm_age * 365
  }
  return(norm_age)
}
```


## Exploratory Data Analysis of Data
```{r}
#Load Libraries I need
library(tidyverse)
library(ggplot2)
library(DataExplorer)
library(caret)
library(gridExtra)
library(reshape)
library(purr)

#Load in data and start transforming it
animal_data <- read_csv(gzfile("data/train.csv.gz")) %>% 
               select(-AnimalID) %>% 
               transform(SexuponOutcome = colsplit(SexuponOutcome, split = "\\s+", names = c('Sexual_Organ_Status', 'Sex')))

animal_data$AgeuponOutcome <- vapply(animal_data$AgeuponOutcome, FUN = timeWarp, FUN.VALUE = double(1)) 

#Convert Name column into factor so we can see if the fact that the pet had a name documented affected it's outcome. 1=Had Name, 0=Name Unknown
animal_data$Sexual_Organ_Status <- animal_data$SexuponOutcome$Sexual_Organ_Status
animal_data$Sex <- animal_data$SexuponOutcome$Sex

animal_data$Name[!is.na(animal_data$Name)] <- 1
animal_data$Name[is.na(animal_data$Name)] <- 0
animal_data$Name <- as.factor(animal_data$Name)

animal_data$OutcomeSubtype[is.na(animal_data$OutcomeSubtype)] <- "None"

#Final steps of cleaning up my data
clean_animal_data <- animal_data %>% 
                     select(-SexuponOutcome) %>% 
                     na.omit()
```

```{r}
View(clean_animal_data)
introduce(clean_animal_data)
```
There are 1380 unique breeds in the dataset. This is far too many
```{r}
length(unique(clean_animal_data$Breed))
```
## Feature Engineering
First we need to clean the dataset to move "mix" into its own feature and keep only the first breed mentioned for the breed mixes
```{r Breed_Features}
clean_animal_data <- clean_animal_data %>%
  mutate(mix = ifelse(grepl("mix", Breed, ignore.case = T), 1, 0),
         breed_new = gsub(" Mix", "", Breed),
         breed_new = strsplit(x = breed_new, split = "/"),
         breed_new = map_chr(breed_new, function(x){unlist(x[1])}))
```

It does look like there are a number of popular breeds that take up more than 75% of the dataset: 
```{r}
clean_animal_data %>%
  count(breed_new, sort = TRUE) %>%
  mutate(freq = round(100 * n / sum(n),2)) %>%
  head(16)
```
```{r}
count(clean_animal_data, breed_new) %>%
    arrange(desc(n)) %>%
    filter(n > 222) -> common

clean_animal_data <- clean_animal_data %>%
  mutate(breed_new = replace(breed_new, !(breed_new %in% common$breed_new), "Uncommon"))
```
We've now grouped the 1365 sparse class breeds into one "Uncommon" group. 
```{r}
clean_animal_data %>%
  count(breed_new, sort = TRUE) %>%
  mutate(freq = round(100 * n / sum(n),2)) 
```


